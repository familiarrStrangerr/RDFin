<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RDfin</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      /* Base layout */
      body { background: #f8f9fa; color: #212529; }
      .strm-name { max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .small-muted { font-size: 0.85rem; color: #6c757d; }
      .card { border-radius: 8px; }
      .logo-img { height: 40px; }

      /* Dark mode overrides */
      body.dark-mode {
        background: #0f1720;
        color: #e6eef6;
      }
      body.dark-mode .card {
        background: #111826;
        color: #e6eef6;
        border-color: rgba(255,255,255,0.03);
        box-shadow: none;
      }
      body.dark-mode .list-group-item {
        background: #0f1720;
        color: #e6eef6;
        border-color: rgba(255,255,255,0.03);
      }

      /* Inputs/select/textarea colors & placeholders */
      body.dark-mode .form-control,
      body.dark-mode .form-select,
      body.dark-mode textarea.form-control {
        background: #0f1720;
        color: #e6eef6;               /* ensure typed text is visible */
        border-color: rgba(255,255,255,0.06);
      }
      body.dark-mode .form-control::placeholder,
      body.dark-mode .form-select::placeholder,
      body.dark-mode textarea.form-control::placeholder {
        color: #9ca3af;               /* lighter placeholder */
        opacity: 1;
      }

      /* Buttons & alerts */
      body.dark-mode .btn-primary {
        background-color: #2563eb;
        border-color: #2563eb;
        color: #fff;
      }
      body.dark-mode .btn-warning {
        background-color: #f59e0b;
        border-color: #f59e0b;
        color: #0b0b0b;
      }
      body.dark-mode .btn-outline-danger {
        color: #ffb4b4;
        border-color: rgba(255,255,255,0.06);
      }
      body.dark-mode .alert {
        background: #0b1220;
        color: #e6eef6;
        border-color: rgba(255,255,255,0.03);
      }

      /* Fix muted text in dark mode (server IP etc) */
      body.dark-mode .text-muted {
        color: #9ca3af !important;
      }

      .header-actions { display:flex; gap:8px; align-items:center; }
      .theme-toggle-btn {
        border: 0;
        background: transparent;
        font-size: 1.1rem;
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 6px;
      }
      .theme-toggle-btn:focus { outline: 2px solid rgba(0,0,0,0.08); outline-offset: 2px; }
      body.dark-mode .theme-toggle-btn:focus { outline: 2px solid rgba(255,255,255,0.06); }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h1 class="mb-0 d-flex align-items-center">
          <img src="{{ url_for('static', filename='logo.png') }}" alt="RDfin" class="logo-img">
        </h1>

        <div class="header-actions">
          <small class="text-muted me-2 d-none d-sm-block">Server: {{ request.host }}</small>
          <button id="themeToggle" class="theme-toggle-btn" title="Toggle light/dark mode" aria-pressed="false">ðŸŒ™</button>
        </div>
      </div>

      <hr class="my-3">

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-3">
            {% for category, msg in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ msg }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div class="row gy-4">
        <!-- LEFT column: Add Movie / Add Episode -->
        <div class="col-lg-6">
          <!-- Add Movie -->
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h5 class="card-title">Add Movie (multiple links)</h5>
              <form method="post" action="/add-movie">
                <div class="mb-3">
                  <textarea class="form-control" name="links" rows="6" placeholder="Paste one link per line..." required></textarea>
                </div>
                <button class="btn btn-primary">Add Movie Links</button>
              </form>
            </div>
          </div>
          <!-- Add Episode -->
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Add Episode (multiple links)</h5>
              <form method="post" action="/add-episode">
                <div class="mb-2">
                  <input class="form-control" name="show" placeholder="Show name" required>
                </div>
                <div class="row g-2 mb-2">
                  <div class="col-5">
                    <input class="form-control" name="season" placeholder="Season" required>
                  </div>
                  <div class="col-7">
                    <input class="form-control" name="episode" placeholder="Episode (optional)">
                  </div>
                </div>
                <div class="mb-2">
                  <textarea class="form-control" name="links" rows="4" placeholder="Paste links, one per line." required></textarea>
                </div>
                <button class="btn btn-primary">Add Episode Links</button>
              </form>
            </div>
          </div>
        </div>

        <!-- RIGHT column: Recently fetched + Log controls -->
        <div class="col-lg-6">
          <!-- Recently fetched Movies -->
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h5 class="card-title mb-2">Recently fetched Movies</h5>
              <ul class="list-group mb-3">
                {% if movies %}
                  {% for rel in movies %}
                    <li class="list-group-item"><div class="strm-name">{{ rel }}</div></li>
                  {% endfor %}
                {% else %}
                  <li class="list-group-item">No movies found</li>
                {% endif %}
              </ul>
              <div class="d-flex gap-2 align-items-center">
                <select class="form-select" id="movieLogSelect">
                  <option value="">Select a movie log to refresh</option>
                  {% for lf in movie_logs %}
                    <option value="{{ lf }}">{{ lf }}</option>
                  {% endfor %}
                </select>
                <form id="movieRefreshForm" method="post" action="/refresh-log">
                  <input type="hidden" name="media_type" value="movies">
                  <input type="hidden" name="logfile" id="movieLogInput">
                  <button class="btn btn-warning" type="submit">Refresh Log</button>
                </form>
                <form id="movieDeleteForm" method="post" action="/delete-log">
                  <input type="hidden" name="media_type" value="movies">
                  <input type="hidden" name="logfile" id="movieDeleteInput">
                  <button class="btn btn-outline-danger" type="submit">Delete Log</button>
                </form>
              </div>
            </div>
          </div>

          <!-- Recently fetched TVs -->
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h5 class="card-title mb-2">Recently fetched TVs</h5>
              <ul class="list-group mb-3">
                {% if tv %}
                  {% for rel in tv %}
                    <li class="list-group-item"><div class="strm-name">{{ rel }}</div></li>
                  {% endfor %}
                {% else %}
                  <li class="list-group-item">No TV found</li>
                {% endif %}
              </ul>
              <div class="d-flex gap-2 align-items-center">
                <select class="form-select" id="tvLogSelect">
                  <option value="">Select a tv log to refresh</option>
                  {% for lf in tv_logs %}
                    <option value="{{ lf }}">{{ lf }}</option>
                  {% endfor %}
                </select>
                <form id="tvRefreshForm" method="post" action="/refresh-log">
                  <input type="hidden" name="media_type" value="tv">
                  <input type="hidden" name="logfile" id="tvLogInput">
                  <button class="btn btn-warning" type="submit">Refresh Log</button>
                </form>
                <form id="tvDeleteForm" method="post" action="/delete-log">
                  <input type="hidden" name="media_type" value="tv">
                  <input type="hidden" name="logfile" id="tvDeleteInput">
                  <button class="btn btn-outline-danger" type="submit">Delete Log</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="mt-4 text-muted small">
        v0.1
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // wire selects to hidden inputs
      document.getElementById('movieLogSelect')?.addEventListener('change', function(){
        document.getElementById('movieLogInput').value = this.value || '';
        document.getElementById('movieDeleteInput').value = this.value || '';
      });
      document.getElementById('tvLogSelect')?.addEventListener('change', function(){
        document.getElementById('tvLogInput').value = this.value || '';
        document.getElementById('tvDeleteInput').value = this.value || '';
      });

      // Dark mode toggle
      const themeToggle = document.getElementById('themeToggle');
      const DARK_KEY = 'rdfin-dark';
      function applyTheme(isDark) {
        if (isDark) {
          document.body.classList.add('dark-mode');
          themeToggle.textContent = 'ðŸŒž';
          themeToggle.setAttribute('aria-pressed', 'true');
        } else {
          document.body.classList.remove('dark-mode');
          themeToggle.textContent = 'ðŸŒ™';
          themeToggle.setAttribute('aria-pressed', 'false');
        }
      }
      (function initTheme(){
        const saved = localStorage.getItem(DARK_KEY);
        if (saved !== null) {
          applyTheme(saved === 'true');
        } else {
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          applyTheme(prefersDark);
        }
      })();
      themeToggle.addEventListener('click', function(){
        const nowDark = document.body.classList.contains('dark-mode');
        applyTheme(!nowDark);
        localStorage.setItem(DARK_KEY, String(!nowDark));
      });
    </script>
  </body>
</html>
